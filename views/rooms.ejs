<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Booking Page</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/public/assets/index.css" type="text/css" />
</head>

<header>
  <div class="container">
    <section class="logo">
      <a href="index"><strong>MEETING ROOM BOOKING</strong></a>
    </section>
    <nav>
      <ul>
        <li> <a href="index">
            Logout
          </a>
        </li>
      </ul>
    </nav>
  </div>
</header>

<div class="row">
  <% if(success!='' ){%>
    <div class="alert alert-success">
      <b></b>
      <%=success%>
    </div>
    <%}%>
      <% if(error!='' ){%>
        <div class="alert alert-error">
          <%=error%>
        </div>
        <%}%>
</div>

<body>
  <div id="login-form-wrap1">
    <h2>Room Booking</h2>
    <form name="myForm" id="myForm" action="/rooms" method="post">

      <!-- for now added dummy update from server code later -->
      <!-- <input type="hidden" name="organizer" id="organizer" value="yelisettimani@gmail.com" /> -->

      <p>
        <i class="bi bi-building"></i>
        <select name="roomname" id="room" style="width: 100%; height: 50px; padding-left: 40px">
          <option value="Cave">Cave</option>
          <option value="Tower">Tower</option>
          <option value="Mansion">Mansion</option>
        </select>
      </p>

      <p>
        <i class="bi bi-people"></i>
        <input type="text" id="persons" name="persons" placeholder="No of Persons (max 2-20)" autocomplete="off"
          required /><i class="validation"></i>
      </p>

      <p>
        <i class="bi bi-pencil"></i>
        <input type="text" id="title" name="title" placeholder="Add Title" pattern="^[a-zA-Z][A-Za-z\s]*$"
          title="Title should start with characters only" autocomplete="off" required /><i class="validation"></i>
      </p>

      <script>
        function datepick() {
          var today = new Date();
          var dd = String(today.getDate()).padStart(2, '0');
          var mm = String(today.getMonth() + 1).padStart(2, '0');
          var yyyy = today.getFullYear();
          today = yyyy + '-' + mm + '-' + dd;
          $('.date_picker').attr('min', today);
        }
      </script>

      <p>
        <i class="bi bi-calendar-date"></i>
        <input type="text" id="startdate" class="date_picker" onclick="datepick();this.type='date'"
          onblur="this.type='text'" name="startdate" placeholder="Start Date" autocomplete="off" required /><i
          class="validation"></i>
      </p>

      <p>
        <i class="bi bi-calendar-date"></i>
        <input type="text" id="enddate" class="date_picker" onclick="datepick();this.type='date'"
          onblur="this.type='text'" name="enddate" placeholder="End Date" autocomplete="off" required /><i
          class="validation"></i>
      </p>

      <p>
        <i class="bi bi-clock"></i>
        <input type="text" id="starttime" name="starttime" class="timepicker" name="time" placeholder="Start Timing"
          onclick="this.type=''" onblur="this.type='text'" autocomplete="off" required /><i class="validation"></i>
      </p>

      <script>
        $(document).ready(function () {
          $(".timepicker").timepicker({
            timeFormat: "HH:mm",
            minTime: new Date().toLocaleTimeString(),
            interval: 15,
            defaultTime: "",
            dynamic: false,
            dropdown: true,
            scrollbar: true,
          });
        });
      </script>

      <p>
        <i class="bi bi-clock"></i>
        <input type="text" id="endtime" class="timepicker" name="endtime" placeholder="End Timing"
          onclick="this.type=''" onblur="this.type='text'" autocomplete="off" required /><i class="validation"></i>
      </p>

      <p>
        <i class="bi bi-envelope"></i>
        <input type="text" id="email" name="attendees" placeholder="Add attendees" autocomplete="off" required /><i
          class="validation"></i>
      </p>
      <p class="alert alert-error user-status d-none"></p>

      <p>
        <input type="submit" id="booking" value="SUBMIT" />
      </p>
    </form>
  </div>

  <script>
    var searchedUsers = [];
    var busyUsers = [];

    $('#startdate, #enddate').on('change', function () {
      searchedUsers = [];
    });
    $('#starttime, #endtime').on('blur', function () {
      searchedUsers = [];
    });

    async function getUserStatus() {
      let $this = $(this);
      let value = $this.val();
      if (value.includes(',')) {
        let users = value.split(',');
        let user = users[users.length - 2];
        let condition = searchedUsers.filter((u) => {
          let key = user.includes('@') ? 'email' : 'username';
          return u[key] === user;
        }).length === 0;
        if (condition) {
          const _data = {
            email: user,
            startdate: $('#startdate').val(),
            enddate: $('#enddate').val(),
            starttime: $('#starttime').val(),
            endtime: $('#endtime').val(),
          }
          $('.user-status').addClass('d-none');
          try {
            const response = await fetch('http://localhost:5000' + `/fetch`, {
              method: 'POST',
              body: JSON.stringify(_data),
              headers: {
                'Content-Type': 'application/json',
              },
            });
            const data = await response.json();
            if (data.user) {
              searchedUsers.push({
                username: data.user.username,
                email: data.user.email,
              });
              if (data.status === 'busy') {
                busyUsers.push(data.user.username);
                $('.user-status').text(`${data.status}`).css('color', 'red');
              } else {
                $('.user-status').text(`${data.status}`).css('color', 'green');
              }
              $('.user-status').removeClass('d-none');
              $('.user-status').text(
                `${data.user.username} is ${data.status}!`
              );
            } else if (data.message) {
              $('.user-status').removeClass('d-none');
              $('.user-status').text(`${data.message}`).css('color', 'red');
              $('.user-status').removeClass('d-none');
            }
          } catch (e) {
            console.log(e);
          }
        }
      }
    }
    $('#email').on('input', getUserStatus);

  </script>
</body>

</html>